---
title: "Final Project"
author: "Brendan Cullen"
date: "2/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

list.of.packages <- c("tidyverse", "ggplot2", "knitr", "rio", "colorblindr", "janitor", "magrittr", "ggrepel", "ggridges")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])] 
if (length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")
lapply(list.of.packages, library, character.only = TRUE)
```


```{r import data}
data_raw <- import("http://bchi.bigcitieshealth.org/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBGdz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--c6b5c30fbd8b79859797e1dc260a06064c8f3864/Current%20BCHI%20Platform%20Dataset%20(7-18)%20-%20Updated%20BCHI%20Platform%20Dataset%20-%20BCHI,%20Phase%20I%20&%20II.csv?disposition=attachment")

# wrangle data
data_filt <- data_raw %>% 
  clean_names() %>% 
  select(shortened_indicator_name, year, sex, race_ethnicity, value, place) %>% 
  filter(shortened_indicator_name %in% c("Adult Physical Activity Levels", "Teen Physical Activity Levels", "Adult Binge Drinking","Adult Obesity","Heart Disease Mortality Rate","Bike Score","Walkability","Median Household Income","Race/Ethnicity","Death Rate (Overall)")) %>% 
  mutate(value = as.numeric(value)) %>% 
  mutate_at(c("sex", "race_ethnicity", "place"), factor) %>% 
  na.omit()
```

# Plot 1 

```{r Plot Obesity rates by city}

# wrangle data
data_obesity <- data_filt %>% 
  filter(shortened_indicator_name == "Adult Obesity") %>% 
  spread(shortened_indicator_name, value) %>% 
  group_by(place) %>% 
  summarise(avg_obesity = mean(`Adult Obesity`, na.rm = TRUE))

# v1
data_obesity %>% 
  ggplot(aes(fct_reorder(place, avg_obesity), avg_obesity)) + 
  geom_col() +
  coord_flip()

# v2
data_obesity %>% 
  ggplot(aes(fct_reorder(place, avg_obesity), avg_obesity)) + 
  geom_col() + 
  coord_flip() +
  #scale_y_continuous(labels = scales::percent) + 
  labs(title = "Percent of Adults Who Are Obese", y = "Percent", x = NULL) + 
  theme_minimal()

# v3
data_obesity %>% 
  mutate(compare_us_tot = ifelse(
    avg_obesity > .$avg_obesity[which(data_obesity$place == "U.S. Total")], "above",
    ifelse(avg_obesity < .$avg_obesity[which(data_obesity$place == "U.S. Total")], "below", "avg"))) %>% 
  ggplot(aes(fct_reorder(place, avg_obesity), avg_obesity)) + 
  geom_col(aes(fill = compare_us_tot)) +
  coord_flip() +
  #scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values = c("#BA4A00", "#7B7D7D", "#27AE60")) +
  labs(title = "Percent of Adults Who Are Obese", y = "Percent", x = NULL, caption = "States above the U.S. average are colored red. States below the U.S. average are colored green.") + 
  theme_minimal() + 
  geom_hline(yintercept = data_obesity$avg_obesity[which(data_obesity$place == "U.S. Total")], linetype = 2) + 
  theme(legend.position = "none")

# v4
data_obesity %>% 
  mutate(compare_us_tot = ifelse(
    avg_obesity > .$avg_obesity[which(data_obesity$place == "U.S. Total")], "above",
    ifelse(avg_obesity < .$avg_obesity[which(data_obesity$place == "U.S. Total")], "below", "avg"))) %>% 
  ggplot(aes(fct_reorder(place, avg_obesity), avg_obesity)) + 
  geom_segment(aes(color = compare_us_tot, x = fct_reorder(place, avg_obesity), xend = place, y=0, yend = avg_obesity), size = 1) +
  geom_point(aes(color = compare_us_tot), size = 3) +
  coord_flip() +
  #scale_y_continuous(labels = scales::percent) + 
  scale_color_manual(values = c("#BA4A00", "#7B7D7D", "#27AE60")) +
  labs(title = "Percent of Adults Who Are Obese", y = "Percent", x = NULL, caption = "States above the U.S. average are colored red. States below the U.S. average are colored green.") + 
  theme_minimal() + 
  geom_hline(yintercept = data_obesity$avg_obesity[which(data_obesity$place == "U.S. Total")], linetype = 2) + 
  theme(legend.position = "none")
```

## replace bars with dots and add se bars. figure out units for x axes. add title. add U.S. total and put dashed vertical line. color everything to the right of the vertical line red and everything below it green or gray. color the U.S. Total bar black. 


# Plot 2
 
```{r Plot relationship between obesity and heart disease mortality rate}
# wrangle data
obesity_hdmr <- data_filt %>%
  filter(shortened_indicator_name %in% c("Adult Obesity", "Heart Disease Mortality Rate"),
         sex == "Both",
         race_ethnicity == "All",
         place != "U.S. Total") %>%
  mutate(i = row_number()) %>%
  spread(shortened_indicator_name, value) %>%
  group_by(place) %>%
  summarize(avg_obesity =  mean(`Adult Obesity`, na.rm = TRUE),
            avg_hdmr = mean(`Heart Disease Mortality Rate`, na.rm = TRUE))

# v1
obesity_hdmr %>% 
  ggplot(aes(avg_obesity, avg_hdmr)) + 
  geom_point() +
  geom_smooth(method = "lm")

# v2
obesity_hdmr %>% 
  ggplot(aes(avg_obesity, avg_hdmr)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  geom_text_repel(aes(label = place)) + 
  theme_minimal()

# v3

## 5 most obese cities
top_3_obese <- obesity_hdmr %>% 
  top_n(3, avg_obesity)

## 5 least obese cities
bottom_3_obese <- obesity_hdmr %>% 
  top_n(-3, avg_obesity)

obesity_hdmr %>% 
  ggplot(aes(avg_obesity, avg_hdmr)) + 
  geom_point(size = 3, alpha = 0.5, color = "gray40") +
  geom_point(data = top_3_obese, color = "red", fill = "red") +
  geom_point(data = bottom_3_obese, color = "green", fill = "green") +
  geom_smooth(method = "lm", alpha = 0.2) +
  geom_text_repel(data = top_3_obese, aes(label = place)) +
  geom_text_repel(data = bottom_3_obese, aes(label = place)) +
  theme_minimal() + 
  labs(x = "Adult Obesity Rate", y = "Heart Disease Mortality Rate", title = "Relationship between Obesity and Heart Disease", caption = "3 most obese states are colored red. 3 lease obese states are colored green.")
```

## Note: data missing for Cleveland, OH and Charlotte, NC. Heart Disease Mortality Rate Age-Adjusted; Per 100,000 people. Adult Obesity Rate = Percent of Adults Who Are Obese.
## ideas: label and use color to highlight top 3 most/least obese cities

# Plot 3

```{r Plot opiod death data over time}
# wrangle data
data_opiod <- data_raw %>% 
  clean_names() %>% 
  select(shortened_indicator_name, year, sex, race_ethnicity, value, place) %>% 
  filter(shortened_indicator_name %in% c("Opioid-Related Overdose Mortality Rate")) %>% 
  mutate(value = as.numeric(value)) %>% 
  mutate_at(c("sex", "race_ethnicity", "place"), factor) %>% 
  na.omit()

# identify city with highest opiod-related overdose mortality rate from 2010 to 2016
top_opioid = data_opiod %>% 
  filter(sex == "Both",
         race_ethnicity == "All",
         place != "U.S. Total",
         year %in% 2010:2016) %>% 
  unique() %>% 
  spread(shortened_indicator_name, value) %>% 
  group_by(place) %>% 
  summarize(mean_opiod = mean(`Opioid-Related Overdose Mortality Rate`, na.rm = TRUE)) %>% 
  top_n(1) %>% 
  select(place)

# v1 
data_opiod %>% 
  filter(sex != "Both", 
         race_ethnicity == "All",
         place == top_opioid$place,
         year %in% 2010:2016) %>% 
  spread(shortened_indicator_name, value) %>% 
  ggplot(aes(year, `Opioid-Related Overdose Mortality Rate`, color= sex)) + 
  geom_line() 

# v2
data_opiod %>% 
  filter(sex != "Both", 
         race_ethnicity == "All",
         place == top_opioid$place,
         year %in% 2010:2016) %>% 
  spread(shortened_indicator_name, value) %>% 
  ggplot(aes(year, `Opioid-Related Overdose Mortality Rate`, color= sex)) + 
  geom_line() + 
  geom_point() + 
  labs(x = NULL, y = "Opioid-Related Overdose Mortality Rate") + 
  theme_minimal()
```

# Note: Rates are age-adjusted per 100,000 people. Data includes all races. 

# Random exploratory plots 

```{r Trends over time}
data_filt %>% 
  filter(shortened_indicator_name == "Adult Obesity",
         place != "U.S. Total",
         year %in% (2010:2014)) %>% 
  spread(shortened_indicator_name, value) %>% 
  #spread(place, `Adult Obesity`) %>% 
  #filter(length(unique(.$year)) == 5) %>% 
  group_by(year, place) %>% 
  summarize(avg_obesity = mean(`Adult Obesity`, na.rm = TRUE)) %>% 
  ggplot(aes(year, avg_obesity)) + 
  geom_line() +
  facet_wrap(~place, nrow = 5)
```


```{r Demographic variables}

data_filt %>% 
  filter(shortened_indicator_name == "Death Rate (Overall)",
         place == "U.S. Total",
         race_ethnicity != "All") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
ggplot(aes(`Death Rate (Overall)`, factor(race_ethnicity, levels = c("Asian/PI", "Hispanic", "American Indian/Alaska Native", "White", "Black")))) +
  geom_density_ridges(color = "white",
                                alpha = 0.4,
                                fill = "#003F9C")




data_filt %>% 
  filter(shortened_indicator_name == "Death Rate (Overall)",
         place == "U.S. Total",
         sex != "Both") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
ggplot(aes(`Death Rate (Overall)`, sex)) +
  geom_density_ridges(color = "white",
                                alpha = 0.4,
                                fill = "#003F9C")


data_filt %>% 
  filter(shortened_indicator_name == "Adult Obesity",
         place == "U.S. Total",
         sex != "Both") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
ggplot(aes(`Adult Obesity`, sex)) +
  geom_density_ridges(color = "white",
                                alpha = 0.4,
                                fill = "#003F9C")


data_filt %>% 
  filter(shortened_indicator_name == "Adult Physical Activity Levels",
         place == "U.S. Total",
         sex != "Both") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
ggplot(aes(`Adult Physical Activity Levels`, sex)) +
  geom_density_ridges(color = "white",
                                alpha = 0.4,
                                fill = "#003F9C")


data_opiod %>% 
  filter(shortened_indicator_name == "Opioid-Related Overdose Mortality Rate",
         place == "U.S. Total",
         sex != "Both") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
ggplot(aes(`Opioid-Related Overdose Mortality Rate`, sex)) +
  geom_density_ridges(color = "white",
                                alpha = 0.4,
                                fill = "#003F9C")


# Heart Disease Mortality Rate
data_filt %>% 
  filter(shortened_indicator_name == "Heart Disease Mortality Rate",
         place != "U.S. Total") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
  group_by(place) %>% 
  summarise(avg_hdmr = mean(`Heart Disease Mortality Rate`, na.rm = TRUE)) %>% 
  ggplot(aes(fct_reorder(place, avg_hdmr), avg_hdmr)) + 
  geom_col() + 
  coord_flip()

# Adult Binge Drinking
data_filt %>% 
  filter(shortened_indicator_name == "Adult Binge Drinking",
         place != "U.S. Total") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
  group_by(place) %>% 
  summarise(avg_binge_drink = mean(`Adult Binge Drinking`, na.rm = TRUE)) %>% 
  ggplot(aes(fct_reorder(place, avg_binge_drink), avg_binge_drink)) + 
  geom_col() + 
  coord_flip()

# Overall Death Rate
data_filt %>% 
  filter(shortened_indicator_name == "Death Rate (Overall)") %>% 
  mutate(i = row_number()) %>% # add a unique index column to prevent spread from   trying to collapse duplicate rows
  spread(shortened_indicator_name, value) %>% 
  select(-i) %>% 
  group_by(place) %>% 
  summarise(avg_death_rate = mean(`Death Rate (Overall)`, na.rm = TRUE)) %>% 
  ggplot(aes(fct_reorder(place, avg_death_rate), avg_death_rate)) + 
  geom_col() + 
  coord_flip()
```


